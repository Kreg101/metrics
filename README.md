# Сервер сбора метрик и алертинга

## Описание

Клиент-серверное **REST API** приложение для сбора статистики про memory allocator. Клиент импортируется на целевые машины, собирает нужные метрики о процессе, в котором он запущен, и отправляет их на сервер, где хранятся данные.

Сервер способен одновременно поддерживать более чем 200 агентов.

## Реализация 

Параметры запуска как и агента, так и сервера задаются с помощью командной строки или переменных окружения. 

Для сервера:

**-a** - адрес и порт для запуска сервера

**-d** - сторка подключения к базе данных (если не указана, используется in-memory хранилище). Переменная окружения - **DATABASE_DSN**

**-f** - путь файла для сохранения метрик (если используется in-memory). Переменная окружения - **FILE_STORAGE_PATH**

**-d** - интервал сохранения метрик в файл (если 0, то синхронная запись в файл). Переменная окружения - **STORE_INTERVAL**

**-r** - нужно ли загружать предыдущие данные. Переменная окружения - **RESTORE**

Для агента:

**-a** - адрес и порт сервера

**-r** - частота отправки данных на сервер. Переменная окружения - **REPORT_INTERVAL**

**-p** - частота обновления метрик. Переменная окружения - **POLL_INTERVAL**

### Сервер

Сервер может работать с тремя видами хранилищ: in-memory, файл, база данных. Все они реализуют интерфейс Repository, за счет чего в зависимости от конфигурации определяется, какое хранилище будет использоваться. Оно передается в параметры сервера.

 В качестве базы данных используется **PostgreSql**. Работа с ней осуществляется по средствам стандартного пакета **database/sql** и драйвера **pgx**. Так как некоторые действия с базой данных требуют нескольких запросов, используются тразакции.

 За основу роутера взят **Chi**. В зависимости от запроса, осуществляется его декомпрессию или компрессию ответа методом **gzip**. Для этого используется подход **middleware**. Также для ограничения времени запроса, происходит работа с контекстом.

 Помимио домпрессии и декомпрессии в **middleware** осуществляется логирование запросов. За основу логгера взят **Zap**, так как он достаточно легкий и производительный. 

 Проект покрыт unit-тестами. В качестве модуля для тестирования взят **Testify**. 

 ### Агент

 Агент способен обновлять и отправлять метрики с заданной частотой. В качестве клиента для отправки http запросов исопльзуется **resty**. 
 
 Обмен данными между клиентом и сервером осуществляется в формате json. Клиент способен отправлять метрики по одной, а также сразу несколько.

 Запускалось более 200 конкурентных агентов, какждый из которых собирал и отправлял метрики на сервер, при этом данные не повредились. Сервер отработал корректно. 
